I"˚<p>I wanted to leave a note on frequently asked API calls (for my personal convenience). They‚Äôre ready to use, you just have to change below fields to your own requirement:</p>

<h3 class="no_toc" id="variables">Variables</h3>

<ul>
  <li><code class="highlighter-rouge">&lt;YOUR_EMAIL&gt;</code> : To specify who‚Äôs requesting. Use the email address you use to access the dashboard.</li>
  <li><code class="highlighter-rouge">&lt;API_KEY&gt;</code> : To authenticate you. Find the key in the dashboard under My Profile - API Tokens - API Keys - Global API Key. Handle this like your password.</li>
  <li><code class="highlighter-rouge">&lt;ZONE_ID&gt;</code> : To specify your domain. Find it in the dashboard under Overview - API - Zone ID.</li>
  <li><code class="highlighter-rouge">&lt;TIME_START&gt;</code> : Start timestamp formatted as rfc3339 or UNIX. Use UTC time.</li>
  <li><code class="highlighter-rouge">&lt;TIME_END&gt;</code> : End timestamp formatted as rfc3339 or UNIX. Use UTC time. When you request logs, you specify ‚ÄúI want logs happened from <code class="highlighter-rouge">&lt;TIME_START&gt;</code> to <code class="highlighter-rouge">&lt;TIME_END&gt;</code>‚Äù <a href="https://developers.cloudflare.com/logs/logpull-api/requesting-logs/#parameters">Details</a></li>
</ul>

<p>Sections with BETA flags mean they‚Äôre not part of official offerings yet. Keep in mind that general beta caveats apply - things can be added, changed, paused or withdrawed, also we would appreciate your constructive feedback!</p>

<h1 class="no_toc" id="table-of-contents">Table of Contents</h1>

<ul id="markdown-toc">
  <li><a href="#raw-logs-ent-only" id="markdown-toc-raw-logs-ent-only">Raw Logs (ENT only)</a>    <ul>
      <li><a href="#retrieve-logs" id="markdown-toc-retrieve-logs">Retrieve Logs</a>        <ul>
          <li><a href="#logpush" id="markdown-toc-logpush">Logpush</a>            <ul>
              <li><a href="#faster-push-beta" id="markdown-toc-faster-push-beta">Faster Push (BETA)</a></li>
              <li><a href="#firewall-events-beta" id="markdown-toc-firewall-events-beta">Firewall Events (BETA)</a></li>
              <li><a href="#new-performance-metrics-beta" id="markdown-toc-new-performance-metrics-beta">New Performance Metrics (BETA)</a></li>
              <li><a href="#add-custom-headers-to-your-logpush-beta" id="markdown-toc-add-custom-headers-to-your-logpush-beta">Add Custom Headers to your Logpush (BETA)</a></li>
            </ul>
          </li>
          <li><a href="#logpull" id="markdown-toc-logpull">Logpull</a>            <ul>
              <li><a href="#enable-log-retention" id="markdown-toc-enable-log-retention">Enable log retention</a></li>
              <li><a href="#pull-your-logs-in-specific-timeframe" id="markdown-toc-pull-your-logs-in-specific-timeframe">Pull your logs in specific timeframe</a></li>
              <li><a href="#pull-your-logs-for-a-specific-rayid" id="markdown-toc-pull-your-logs-for-a-specific-rayid">Pull your logs for a specific RayID</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#analyse-logs" id="markdown-toc-analyse-logs">Analyse Logs</a>        <ul>
          <li><a href="#error-analysis-in-specific-timeframe" id="markdown-toc-error-analysis-in-specific-timeframe">Error analysis in specific timeframe</a></li>
          <li><a href="#map-each-requests-clientcountry-information-to-corresponding-cloudflare-colo" id="markdown-toc-map-each-requests-clientcountry-information-to-corresponding-cloudflare-colo">Map each request‚Äôs clientCountry information to corresponding Cloudflare colo</a></li>
          <li><a href="#pathingstatus-information-per-status-codes" id="markdown-toc-pathingstatus-information-per-status-codes">PathingStatus information per Status Codes</a></li>
          <li><a href="#top-20-clientip-top-20-useragents-in-specific-timeframe" id="markdown-toc-top-20-clientip-top-20-useragents-in-specific-timeframe">Top 20 clientIP, top 20 userAgents in specific timeframe</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#web-application-firewall" id="markdown-toc-web-application-firewall">Web Application Firewall</a>    <ul>
      <li><a href="#minimize-false-negatives" id="markdown-toc-minimize-false-negatives">Minimize False Negatives</a></li>
      <li><a href="#minimize-false-positives" id="markdown-toc-minimize-false-positives">Minimize False Positives</a></li>
      <li><a href="#waf-override-ent-only" id="markdown-toc-waf-override-ent-only">WAF Override (ENT Only)</a>        <ul>
          <li><a href="#retrieve-current-waf-override-rules" id="markdown-toc-retrieve-current-waf-override-rules">Retrieve current WAF Override rules</a></li>
          <li><a href="#create-a-new-waf-override-rule" id="markdown-toc-create-a-new-waf-override-rule">Create a new WAF Override rule</a></li>
          <li><a href="#delete-undesired-override-rules" id="markdown-toc-delete-undesired-override-rules">Delete undesired override rules</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="raw-logs-ent-only">Raw Logs (ENT only)</h1>

<p>Detailed request logs that were processed at Cloudflare enterprize zone. You may use either Logpush or Logpull to analyse what happened in detailed manner. All API calls under this section is available for enterprise zone only.</p>

<h2 id="retrieve-logs">Retrieve Logs</h2>

<h3 id="logpush">Logpush</h3>

<p>You‚Äôll configure the endpoint you want to get the logs saved, then Cloudflare will <strong>push</strong> your logs to that endpoint every 5 minutes. <a href="https://developers.cloudflare.com/logs/logpush/">Get Started</a></p>

<p>As of 28/May/2020, below data sets are available.</p>
<ul>
  <li>http requests</li>
  <li>spectrum events</li>
</ul>

<h4 id="faster-push-beta">Faster Push (BETA)</h4>

<p>Up-to-date on: 2020-05-28</p>

<p>Logpush sends you processed logs every 5 minutes. You can make push job even faster which is currently under early access / available via API only. Once enabled, Cloudflare will send log files every 30 seconds instead of 5 minutes. If there was no request made in 30 seconds you won‚Äôt get the logfile. For your information, the existing Logpush jobs will be updated to this once Beta is completed.</p>

<p>Below are steps to enable faster push. Firstly, run below query to retrieve your existing logpush job ID.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span>     <span class="s1">'https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logpush/jobs'</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>

<p>You‚Äôll find the Logpush job id looks like <code class="highlighter-rouge">"id": 14644,</code>
Save your job id as it will be used at the next query.</p>

<p>Run below query to update current logpush job to faster one (logstream)</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="no">X</span> <span class="no">PUT</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logpush/jobs/&lt;JOB_ID&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="p">\</span>
     <span class="o">--</span><span class="n">data</span> <span class="s1">'{"logstream":true}'</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>

<p>Confirm you got <code class="highlighter-rouge">"logstream": true,</code> and <code class="highlighter-rouge">"success": true</code> from the response. Once enabled, you‚Äôll receive your logs pushed far more frequently.</p>

<p>If you didn‚Äôt even configure any logpush but you need this, look at <a href="https://developers.cloudflare.com/logs/logpush/">our developers doc</a> and <a href="/cloudflare/analytics/2020/05/15/tutorial-cloudflare-logpush.html">my tutorial</a> to get started. You can use API POST request to create a new Logpush job and already add a necessary option to it.</p>

<h4 id="firewall-events-beta">Firewall Events (BETA)</h4>

<p>Up-to-date on: 2020-05-28</p>

<p>Although Firewall events are not part of log offerings yet (You can still use GraphQL API to pull events), but as of 28/May/2020, available at Logpush only as early access. You can only enable this data via API.</p>

<p>Run below query to see what data is available.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">X</span> <span class="no">GET</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">api</span><span class="p">.</span><span class="nf">cloudflare</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">client</span><span class="o">/</span><span class="n">v4</span><span class="o">/</span><span class="n">zones</span><span class="o">/&lt;</span><span class="no">ZONE_ID</span><span class="o">&gt;</span><span class="sr">/logpush/</span><span class="n">datasets</span><span class="o">/</span><span class="n">firewall_events</span><span class="o">/</span><span class="n">fields</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span></code></pre></figure>

<p>If you‚Äôd like to try this dataset at your Logpush, please contact your account team (CSM/SE).</p>

<h4 id="new-performance-metrics-beta">New Performance Metrics (BETA)</h4>

<p>Up-to-date on: 2020-05-28</p>

<p>As part of <code class="highlighter-rouge">http_requests</code> dataset, the data team at Cloudflare is making new performance metrics available. These fields give much more detail about request timing hence will be helpful to troubleshoot latency issues. This feature is early access, available at Logpush only. Also, you need to enable <a href="#faster-push-beta">Logstream(Look at Faster Logpush)</a> to use them.</p>

<p>Please contact your account team for more information including fields and definition.</p>

<p>Below are steps to enable these fields. Firstly, run below query to retrieve your existing logpush job ID.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span>     <span class="s1">'https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logpush/jobs'</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>

<p>You‚Äôll find the Logpush job id looks like <code class="highlighter-rouge">"id": 14644,</code> Save your job id as it will be used at the next query. Make sure you‚Äôre updating <code class="highlighter-rouge">https_requests</code> not something else.
Also, for the job you want to update, copy what‚Äôs currently inside at <code class="highlighter-rouge">logpull_options</code> for e.g.:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      <span class="s2">"logpull_options"</span><span class="p">:</span> <span class="s2">"fields=RayID,ClientIP&amp;timestamps=rfc3339"</span><span class="p">,</span></code></pre></figure>

<p>Let‚Äôs say it‚Äôs what you currently have, we will add timing metrics into it. They‚Äôre:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">fields</span><span class="o">=</span><span class="no">EdgeTimeToFirstByteMs</span><span class="p">,</span><span class="no">ClientTCPRTTMs</span><span class="p">,</span><span class="no">OriginDNSResponseTimeMs</span><span class="p">,</span><span class="no">OriginTCPHandshakeDurationMs</span><span class="p">,</span><span class="no">OriginTLSHandshakeDurationMs</span><span class="p">,</span><span class="no">OriginRequestHeaderSendDurationMs</span><span class="p">,</span><span class="no">OriginResponseHeaderReceiveDurationMs</span><span class="p">,</span><span class="no">OriginResponseDurationMs</span><span class="p">,</span><span class="no">EdgeResponseBodyBytes</span></code></pre></figure>

<p>Once you add timing metrics, your updated <code class="highlighter-rouge">logpull_options</code> will look like below:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">      <span class="s2">"logpull_options"</span><span class="p">:</span> <span class="s2">"fields=RayID,ClientIP,EdgeTimeToFirstByteMs,ClientTCPRTTMs,OriginDNSResponseTimeMs,OriginTCPHandshakeDurationMs,OriginTLSHandshakeDurationMs,OriginRequestHeaderSendDurationMs,OriginResponseHeaderReceiveDurationMs,OriginResponseDurationMs,EdgeResponseBodyBytes&amp;timestamps=rfc3339"</span><span class="p">,</span></code></pre></figure>

<p>We‚Äôll use this to update your existing Logpush. Run the query below.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="no">X</span> <span class="no">PUT</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logpush/jobs/&lt;JOB_ID&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="p">\</span>
     <span class="o">--</span><span class="n">data</span> <span class="s1">'{"logstream": true,"logpull_options":"&lt;UPDATED_LOGPULL_OPTIONS&gt;"}'</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>

<p>Confirm you got <code class="highlighter-rouge">"success": true</code> from the response. Once enabled, you‚Äôll be able to retrieve performance metrics in your current <code class="highlighter-rouge">http_requests</code> Logpush job.</p>

<p>If you didn‚Äôt even configure any logpush but you need this, look at <a href="https://developers.cloudflare.com/logs/logpush/">our developers doc</a> and <a href="/cloudflare/analytics/2020/05/15/tutorial-cloudflare-logpush.html">my tutorial</a> to get started. You can use API POST request to create a new Logpush job and already add a necessary fields to it.</p>

<h4 id="add-custom-headers-to-your-logpush-beta">Add Custom Headers to your Logpush (BETA)</h4>

<p>Up-to-date on: 2020-05-28</p>

<p><a href="https://developers.cloudflare.com/logs/log-fields/#http-requests">On top of these all 50+ fields</a> Cloudflare Logs/<code class="highlighter-rouge">http_requests</code> dataset provides, if you wish to add another request headers, response headers, or even cookies to your Logpush, this feature can help you. This is currently under early access.</p>

<p>You need to use Logpush and <a href="#faster-push-beta">also enable Logstream flag</a> to use this.</p>

<p>If you‚Äôd like to try this, firstly, make sure you have a Logpush job and <a href="#faster-push-beta">enable Logstream flag</a> to your Logpush job. Then contact your account team (CSM/SE), and tell them what fields you want to add and why.</p>

<h3 id="logpull">Logpull</h3>

<p>Unlike Logpush, with Logpull you can pull detailed request logs to your choice of servers or laptops by using API queries. You should always <a href="#enable-log-retention">enable log retention</a> first to go with this option. Use the below query to see if log retention is already on.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="no">GET</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logs/control/retention/flag"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span></code></pre></figure>

<p>Confirm you can see <code class="highlighter-rouge">"flag": true</code>.</p>

<p>As of 28 May, retention is for last 72 hours (up to 7 days). Do use your storage to regularly pull and save raw logs if you need them for longer period. <a href="https://developers.cloudflare.com/logs/logpull-api/understanding-the-basics/#data-retention-period">Data Retention Period</a> <a href="/cloudflare/analytics/2019/03/20/pulling-cloudflare-logs-with-bash.html">Script to pull Cloudflare logs periodically</a></p>

<h4 id="enable-log-retention">Enable log retention</h4>

<p>Source: <a href="https://developers.cloudflare.com/logs/logpull-api/enabling-log-retention/">https://developers.cloudflare.com/logs/logpull-api/enabling-log-retention/</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="no">X</span> <span class="no">POST</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logs/control/retention/flag"</span> <span class="o">-</span><span class="n">d</span><span class="s1">'{"flag":true}'</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span></code></pre></figure>

<h4 id="pull-your-logs-in-specific-timeframe">Pull your logs in specific timeframe</h4>

<p>You have to <a href="#enable-log-retention">enable log retention</a> to be able to use this.</p>

<p>This query will pull every available detailed logs for the given timeframe in your current working directory.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="p">\</span>
    <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
    <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="p">\</span>
    <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logs/received?start=&lt;TIME_START&gt;&amp;end=&lt;TIME_END&gt;&amp;fields=$(curl -s -H "</span><span class="no">X</span><span class="o">-</span><span class="no">Auth</span><span class="o">-</span><span class="no">Email</span><span class="p">:</span> <span class="o">&lt;</span><span class="no">YOUR_EMAIL</span><span class="o">&gt;</span><span class="s2">" -H "</span><span class="no">X</span><span class="o">-</span><span class="no">Auth</span><span class="o">-</span><span class="no">Key</span><span class="p">:</span> <span class="o">&lt;</span><span class="no">API_KEY</span><span class="o">&gt;</span><span class="s2">" "</span><span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">api</span><span class="p">.</span><span class="nf">cloudflare</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">client</span><span class="o">/</span><span class="n">v4</span><span class="o">/</span><span class="n">zones</span><span class="o">/&lt;</span><span class="no">ZONE_ID</span><span class="o">&gt;</span><span class="sr">/logs/</span><span class="n">received</span><span class="o">/</span><span class="n">fields</span><span class="s2">" | jq '. | to_entries[] | .key' -r | paste -sd "</span><span class="p">,</span><span class="s2">" -)&amp;timestamps=RFC3339"</span> <span class="o">&gt;</span> <span class="n">logpull</span><span class="p">.</span><span class="nf">json</span></code></pre></figure>

<p>With this query, the detailed logs for http requests happened from <code class="highlighter-rouge">&lt;TIME_START&gt;</code> to <code class="highlighter-rouge">&lt;TIME_END&gt;</code> will be returned in <code class="highlighter-rouge">logpull.json</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logs/received/fields</span></code></pre></figure>

<p>With this query, you can find what the details are, what fields will be downloaded. Should you need explanation on each field, <a href="https://developers.cloudflare.com/logs/log-fields/">please refer to this document.</a> Should you need regular pull of your logs than one-off download, <a href="/cloudflare/analytics/2019/03/20/pulling-cloudflare-logs-with-bash.html">you may want to refer to this bash script.</a></p>

<h4 id="pull-your-logs-for-a-specific-rayid">Pull your logs for a specific RayID</h4>

<p>You have to <a href="#enable-log-retention">enable log retention</a> to be able to use this.</p>

<p>This will pull every available detail for the given request, once you put corresponding RayId.</p>

<p>Here, you also need to replace <code class="highlighter-rouge">&lt;RAY_ID&gt;</code> to the actual RayId (like <code class="highlighter-rouge">59a4189c0813b76f</code>) you would like to investigate.</p>

<p>Source: <a href="https://developers.cloudflare.com/logs/logpull-api/requesting-logs/#parameters">https://developers.cloudflare.com/logs/logpull-api/requesting-logs/#parameters</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="no">X</span> <span class="no">GET</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/logs/rayids/&lt;RAY_ID&gt;?&amp;fields=$(curl -s -H "</span><span class="no">X</span><span class="o">-</span><span class="no">Auth</span><span class="o">-</span><span class="no">Email</span><span class="p">:</span> <span class="o">&lt;</span><span class="no">YOUR_EMAIL</span><span class="o">&gt;</span><span class="s2">" -H "</span><span class="no">X</span><span class="o">-</span><span class="no">Auth</span><span class="o">-</span><span class="no">Key</span><span class="p">:</span> <span class="o">&lt;</span><span class="no">API_KEY</span><span class="o">&gt;</span><span class="s2">" "</span><span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">api</span><span class="p">.</span><span class="nf">cloudflare</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">client</span><span class="o">/</span><span class="n">v4</span><span class="o">/</span><span class="n">zones</span><span class="o">/&lt;</span><span class="no">ZONE_ID</span><span class="o">&gt;</span><span class="sr">/logs/</span><span class="n">received</span><span class="o">/</span><span class="n">fields</span><span class="s2">" | jq '. | to_entries[] | .key' -r | paste -sd "</span><span class="p">,</span><span class="s2">" -)&amp;timestamps=RFC3339"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="p">\</span>
     <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>

<h2 id="analyse-logs">Analyse Logs</h2>

<p>You may have been confused what to do if you got your logs and looking at them, as they don‚Äôt look friendly readable for human but big flow of data. If you‚Äôre Cloudflare partner you may need to just go ahead and set up a SIEM to support your enterprise customer. If you‚Äôre a direct enterprise customer and you think setting up a SIEM for this costs more than the goods, then you may want to just run some simple jq queries to analyse your log files - which is what will be addressed in this section.</p>

<p>Every queries in this section assumes you have used Logpush and Logpull already to get your logs saved in your current working directory. If you don‚Äôt have logs yet, follow <a href="https://developers.cloudflare.com/logs/logpush/">official Logpush tutorial</a> or <a href="/cloudflare/analytics/2020/05/15/tutorial-cloudflare-logpush.html">my Logpush tutorial</a> and download pushed logs in your working directory.</p>

<p>If you‚Äôd rather use Logpull, <a href="#pull-your-logs-in-specific-timeframe">use this query</a> to get your http request logs downloaded.</p>

<h3 id="error-analysis-in-specific-timeframe">Error analysis in specific timeframe</h3>

<p>This jq query helps you to find tendency of 4xx, 5xx errors - if the status codes were returned by Cloudflare edge or the origin server.</p>

<p>Firstly, make sure your current working directory has the logs for the timeframe that needs to be analysed.</p>

<p>If your log format follows <code class="highlighter-rouge">.log.gz</code> run the below query - likely applicable for Logpush.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cat</span> <span class="o">*</span><span class="p">.</span><span class="nf">log</span><span class="p">.</span><span class="nf">gz</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s2">"(.EdgeResponseStatus|tostring) + </span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="s2"> + (.OriginResponseStatus|tostring)"</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="n">c</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n15</span></code></pre></figure>

<p>If your log format follows <code class="highlighter-rouge">.json</code> run the below query - likely applicable for Logpull.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cat</span> <span class="o">*</span><span class="p">.</span><span class="nf">json</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s2">"(.EdgeResponseStatus|tostring) + </span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="s2"> + (.OriginResponseStatus|tostring)"</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="n">c</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n15</span></code></pre></figure>

<p>Once you run the query, you‚Äôll find the output like below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  390 403 0    
  150 200 200
   22 301 301
    8 404 404
    2 403 403
</code></pre></div></div>
<p>The first column represents number of requests, and the next one represents <code class="highlighter-rouge">EdgeResponseStatus</code> while the third one represents <code class="highlighter-rouge">OriginResponseStatus</code>. You can see there were 390 requests that were dropped by Cloudflare with 403 Forbidden without touching the origin server. There were only 2 requests that were dropped by the origin server with 403 Forbidden and Cloudflare edge just forwarded 403 to the client. Like this, you can use this query to analyze where exactly the error status came from, if Cloudflare edge or the origin.</p>

<h3 id="map-each-requests-clientcountry-information-to-corresponding-cloudflare-colo">Map each request‚Äôs clientCountry information to corresponding Cloudflare colo</h3>

<p>Cloudflare uses Anycast to route the visitors‚Äô request to the neareat available colo, following BGP. This query helps you to analyze if requests from certain country(e.g. Singapore) was serviced in which Cloudflare colo(e.g. Singapore data center, SIN) in certain timeframe.</p>

<p>Firstly, make sure your current working directory has the logs for the timeframe that needs to be analysed.</p>

<p>If your log format follows <code class="highlighter-rouge">.log.gz</code> run the below query - likely applicable for Logpush. If your logs are formatted in <code class="highlighter-rouge">.json</code> or <code class="highlighter-rouge">.log</code>, please modify the query accordingly.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cat</span> <span class="o">*</span><span class="p">.</span><span class="nf">log</span><span class="p">.</span><span class="nf">gz</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s2">".ClientCountry + </span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="s2"> + .EdgeColoCode"</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="n">c</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n30</span></code></pre></figure>

<p>Once you run the query, you‚Äôll find the output like below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  562 sg SIN
  516 us SEA
  501 xx SEA
  162 xx IAD
  168 us IAD
   83 xx SIN
   81 xx AMS
   78 us EWR
   61 xx EWR
   60 nl AMS
    5 jp NRT
</code></pre></div></div>

<p>The first column represents number of requests, and the next one represents <code class="highlighter-rouge">ClientCountry</code> while the third one represents <code class="highlighter-rouge">EdgeColoCode</code>. You can see there were 562 requests were from visitors in Singapore(sg) and were serviced at Cloudflare Singapore colo(SIN), 516 requests were from visitors in the United States(us) and were serviced at Cloudflare Seattle colo(SEA) ‚Ä¶ and 5 requests were from visitors in Japan(jp) and were serviced in Cloudflare Tokyo colo(NRT). Like this, you can use this jq to analyze visitors (including attackers) from which country were routed to which Cloudflare colo.</p>

<p>Note: If you‚Äôre to submit a support ticket based on this query, you need to share the raw log that was used for analysis. If you just refer to something summarized without details, support engineer may get confused.</p>

<h3 id="pathingstatus-information-per-status-codes">PathingStatus information per Status Codes</h3>

<p>Firstly, make sure your current working directory has the logs for the timeframe that needs to be analysed.</p>

<p>If your log format follows <code class="highlighter-rouge">.log.gz</code> run the below query - likely applicable for Logpush. If your logs are formatted in <code class="highlighter-rouge">.json</code> or <code class="highlighter-rouge">.log</code>, please modify the query accordingly.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cat</span> <span class="o">*</span><span class="p">.</span><span class="nf">log</span><span class="p">.</span><span class="nf">gz</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s2">"(.EdgeResponseStatus|tostring) + </span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="s2"> + .EdgePathingOp + </span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="s2"> + .EdgePathingSrc + </span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="s2"> + .EdgePathingStatus"</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="n">c</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n30</span></code></pre></figure>

<p>Once you run the query, you‚Äôll find the output like below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 101 403 ban filterBasedFirewall nr
  74 403 chl user captchaNew
  49 200 wl macro se
  20 304 wl macro nr
  19 301 wl macro mon
  18 503 chl filterBasedFirewall jschlNew
  10 304 wl user nr
  10 200 wl macro nr
   8 200 wl macro unknown
   6 404 wl macro nr
</code></pre></div></div>

<p>The first column represents number of requests, and the next one represents <code class="highlighter-rouge">EdgeResponseStatus</code> followed by <code class="highlighter-rouge">EdgePathingOp</code>, <code class="highlighter-rouge">EdgePathingSrc</code>, <code class="highlighter-rouge">EdgePathingStatus</code>. <a href="https://developers.cloudflare.com/logs/reference/pathing-status/#body-inner">Refer to this documentation to learn further what each value indicates.</a></p>

<h3 id="top-20-clientip-top-20-useragents-in-specific-timeframe">Top 20 clientIP, top 20 userAgents in specific timeframe</h3>

<p>Firstly, make sure your current working directory has the logs for the timeframe that needs to be analysed.</p>

<p>If your log format follows <code class="highlighter-rouge">.log.gz</code> run the below query - likely applicable for Logpush. If your logs are formatted in <code class="highlighter-rouge">.json</code> or <code class="highlighter-rouge">.log</code>, please modify the query accordingly.</p>

<p><strong>Top 20 clientIP</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cat</span> <span class="o">*</span><span class="p">.</span><span class="nf">log</span><span class="p">.</span><span class="nf">gz</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s2">".ClientIP"</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="n">c</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n20</span></code></pre></figure>

<p>Example output:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  129 216.244.66.197
  110 106.75.118.223
  103 106.75.85.117
  ...
</code></pre></div></div>

<p><strong>Top 20 userAgent</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cat</span> <span class="o">*</span><span class="p">.</span><span class="nf">log</span><span class="p">.</span><span class="nf">gz</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s2">".ClientRequestUserAgent"</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="n">c</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">nr</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n20</span></code></pre></figure>

<p>Example output:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  254 Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36
  148 Mozilla/5.0 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)
  130 Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36
  ...
</code></pre></div></div>

<p>As shown, this query will return Top 20 clientIPs and userAgents order by number of requests they sent DESC.</p>

<h1 id="web-application-firewall">Web Application Firewall</h1>

<p>Cloudflare WAF is a good way for you to stay up-to-date against newly discovered web vulnerabilities as well as already-well-known ones. Even if something is newly found this week, or possibly next week, <a href="https://developers.cloudflare.com/waf/change-log/">Cloudflare WAF team will patch it for your application.</a> You can‚Äôt benefit from WAF patch if you didn‚Äôt turn the WAF on so do make sure your WAF is on.</p>

<ul>
  <li>As for Cloudflare Managed Ruleset, turn at least two rulesets always on: <strong>Cloudflare Specials</strong> Ruleset and <strong>Cloudflare Miscellaneous</strong> Ruleset. For the others, review if the rulesets descriptions are anything to do with technology stack that‚Äôs used for your application. If any of them are used, turn them on. <a href="https://support.cloudflare.com/hc/en-us/articles/200172016-Understanding-the-Cloudflare-Web-Application-Firewall-WAF-#4vxxAwzbHx0eQ8XfETjxiN">Learn more</a></li>
  <li>As for OWASP ModSecurity Ruleset, it works a bit differently. <a href="https://support.cloudflare.com/hc/en-us/articles/200172016-Understanding-the-Cloudflare-Web-Application-Firewall-WAF-#sJbboLurEVhipzWYJQnyz">Learn more here.</a></li>
</ul>

<p>I‚Äôm documenting some frequently asked/answered API queries about WAF API, for my own convenience. If you would like to learn about WAF itself, <a href="https://support.cloudflare.com/hc/en-us/articles/200172016-Understanding-the-Cloudflare-Web-Application-Firewall-WAF-">here‚Äôs your go-to-page.</a></p>

<h2 class="no_toc" id="waf-fine-tuning">WAF Fine Tuning</h2>

<p>You just turned Cloudflare WAF on? You guys‚Äô end goals will be common - to have proper protection against vulnerabilities - but about how to get started, you may have different opinions.</p>

<ul>
  <li>You want to follow our recommendation, and also want to maximize detection rate? <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-ko.html#%EB%AF%B8%ED%83%90false-negative-%EC%A4%84%EC%9D%B4%EA%B8%B0">Start here</a></li>
  <li>ÌòÑÏû¨Ïùò Ìä∏ÎûòÌîΩÏóê ÏïÑÎ¨¥ ÏòÅÌñ•ÏùÑ Ï£ºÏßÄ ÏïäÏúºÎ©¥ÏÑú, ÌïòÎÇòÏî© ÌÉêÏßÄ Î£∞ÏùÑ ÏºúÍ∞ÄÎäî Î∞©ÏãùÏùÑ ÏõêÌïòÏãúÎ©¥, <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-ko.html#%EC%98%A4%ED%83%90false-positive-%EC%A4%84%EC%9D%B4%EA%B8%B0">Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞ ÏãúÏûëÌïòÏÑ∏Ïöî.</a></li>
</ul>

<h2 id="minimize-false-negatives">Minimize False Negatives</h2>

<p>Cloudflare WAFÎ•º Ï≤òÏùå ÌôúÏÑ±ÌôîÌïòÏãúÎ©¥, 2020-06-06 Í∏∞Ï§Ä, 413Í∞úÏùò Cloudflare Managed RulesetÍ≥º, 2491+Í∞úÏùò OWASP ModSecurity RulesetÏù¥ Default Î™®ÎìúÎ°ú ÎèôÏûëÌï©ÎãàÎã§. Default Î™®ÎìúÎûÄ 2,700ÎßåÍ∞úÏùò Cloudflare Í≥†Í∞ù ÏÑúÎπÑÏä§Î•º Í∞ÄÏû• ÏµúÏ†ÄÏùò Ïò§ÌÉêÏú®(False Positive)Í≥º ÎØ∏ÌÉêÏú®(False Negative)Î°ú Î≥¥Ìò∏Ìï¥ ÎìúÎ¶¨Í∏∞ ÏúÑÌïú Ï∂îÏ≤ú Î™®ÎìúÏûÖÎãàÎã§.</p>

<p>Îî∞ÎùºÏÑú Ïù¥ Î™®ÎìúÎ•º Í∑∏ÎåÄÎ°ú ÌôúÏö©ÌïòÏãúÍ∏∞Î•º Ï∂îÏ≤úÌïòÎäî ÌïúÌé∏, Ïñ¥ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÎßàÎã§Ïùò ÌäπÏÑ±Ïóê ÎßûÍ≤å, Í∑∏Î¶¨Í≥† Í≥†Í∞ùÏÇ¨Ïùò ÎØºÍ∞êÎèÑÏóê ÎßûÍ≤å fine-tuning ÌïòÏã§ Ïàò ÏûàÎèÑÎ°ù Enterprise Í≥†Í∞ùÏóê ÌïúÏ†ïÌïòÏó¨ ÏßÄÏõêÌï¥ ÎìúÎ¶¨Í≥† ÏûàÏäµÎãàÎã§.</p>

<p>Fine-tuningÏùò ÏãúÏûëÏ†êÏùÑ, <strong>‚ÄòÏ∂îÏ≤úÏÑ§Ï†ïÏúºÎ°ú ÏãúÏûëÌïòÎêò, Ï∂îÏ≤úÏÑ§Ï†ïÏóêÏÑú Ïû°ÌûàÏßÄ ÏïäÎäî Í≥µÍ≤©ÎèÑ Îã§ Ï∫êÏπòÌïòÍ≥† Ïã∂Îã§‚Äô</strong> Î°ú Ïû°ÏúºÏãúÎäî Í≤ΩÏö∞ - Î≥¥ÌÜµ Î≥¥ÏïàÏóê ÎåÄÌïú awarenessÍ∞Ä ÎÜíÏúºÏã† Í≤ΩÏö∞ Ïó¨Í∏∞ÏÑú ÏãúÏûëÌï©ÎãàÎã§ - Ïù¥ ÏÑπÏÖòÏù¥ ÎèÑÏõÄÏù¥ Îê† Í≤ÉÏûÖÎãàÎã§.</p>

<h3 class="no_toc" id="owasp-waf-Î£∞ÏùÑ-Î™®Îëê-ÏºúÍ∏∞">OWASP WAF Î£∞ÏùÑ Î™®Îëê ÏºúÍ∏∞</h3>

<p>OWASP WAF Î£∞ÏÖãÏùò ÌäπÏßïÏùÑ <a href="https://support.cloudflare.com/hc/en-us/articles/200172016-Understanding-the-Cloudflare-Web-Application-Firewall-WAF-#sJbboLurEVhipzWYJQnyz">Ïù¥ Í∏∞Ïà† Î¨∏ÏÑúÏóêÏÑú ÏùΩÏñ¥ Î≥¥ÏãúÍ∏∞ Î∞îÎûçÎãàÎã§</a>. Ïù¥ ÏÑπÏÖòÏóêÏÑúÎäî OWASPÍ∞Ä catch-allÏùÑ Ïûò ÌïòÍ≤å ÌïòÍ∏∞ ÏúÑÌï¥, Í≥†Í∞ùÏÑúÎπÑÏä§ÏôÄ Ïú†Í¥ÄÌïú Î™®Îì† Íµ¨ÌòÑÎêú Î£∞Îì§ÏùÑ Ïº§ Í≤ÉÏûÖÎãàÎã§.</p>

<p>Î®ºÏ†Ä, ÏïÑÎûò APIÎ•º Ïç®ÏÑú <code class="highlighter-rouge">OWASP ModSecurity Core Rule Set</code>Ïùò Ìå®ÌÇ§ÏßÄ IDÎ•º ÏñªÏñ¥Ïò§Ïã≠ÏãúÏò§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rule-packages-properties">https://api.cloudflare.com/#waf-rule-packages-properties</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/packages"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s1">'.result[] | {package: .name, id: .id}'</span></code></pre></figure>

<p>ÏïÑÎûò ÏøºÎ¶¨ÏóêÏÑú Î∞©Í∏à ÏñªÏñ¥Ïò® <code class="highlighter-rouge">&lt;PACKAGE_ID&gt;</code> Î∂ÄÎ∂ÑÏùÑ Î∂ôÏó¨ÎÑ£Ïñ¥ ÏïÑÎûò API ÏΩúÏùÑ ÎèåÎ¶¨Ïã≠ÏãúÏò§.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;m"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/packages/&lt;PACKAGE_ID&gt;/groups"</span> <span class="o">|</span> <span class="n">jq</span> <span class="s1">'.result[] | {id: .id, name: .name, mode: .mode, count: .rules_count}'</span></code></pre></figure>

<p>Ïù¥ ÏøºÎ¶¨Ïùò Í≤∞Í≥º Ï§ë <code class="highlighter-rouge">"mode": "off"</code> Î•º Î≥¥ÏãúÎ©¥ Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Í∫ºÏ†∏ ÏûàÎäî OWASP Î£∞ÏÖãÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§. Í∫ºÏ†∏ ÏûàÎäî Î£∞ÏÖãÏù¥ Í∑ÄÏÇ¨Ïùò ÏÑúÎπÑÏä§Ïóê ÏÇ¨Ïö©Îêú Í∏∞Ïà† Ïä§ÌÉùÍ≥º Í¥ÄÍ≥ÑÍ∞Ä ÏóÜÎã§Î©¥ Í∑∏ÎåÄÎ°ú ÎëêÏã≠ÏãúÏò§. ÏùºÎ∞òÏ†ÅÏù∏ Î£∞ÏÖãÏóê Ìï¥ÎãπÎêòÍ±∞ÎÇò Í∑ÄÏÇ¨Ïùò ÏÑúÎπÑÏä§Ïóê ÏÇ¨Ïö©Îêú Í∏∞Ïà† Ïä§ÌÉùÍ≥º Í¥ÄÍ≥ÑÍ∞Ä ÏûàÎã§Î©¥ ÏïÑÎûò Î∞©Î≤ï Ï§ë Ìïú Í∞ÄÏßÄÎ•º Ïù¥Ïö©ÌïòÏó¨ ÏºúÎèÑÎ°ù ÌïòÏã≠ÏãúÏò§.</p>

<ul>
  <li>UI: Cloudflare ÎåÄÏãúÎ≥¥Îìú - Firewall - Managed Rules - Package: OWASP ModSecurity Core Rule SetÏóêÏÑú Î™®Îìú Î≥ÄÍ≤Ω</li>
  <li>API: <a href="https://api.cloudflare.com/#waf-rule-groups-edit-rule-group">Ïù¥ PATCH ÏøºÎ¶¨</a>Î•º Ïù¥Ïö©ÌïòÏÖîÏÑú modeÎ•º onÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ ÌïòÏãúÎ©¥ Îê©ÎãàÎã§.</li>
</ul>

<p>ÌïÑÏöîÌïú Î™®Îì† Î£∞Ïù¥ Ïûò ÏºúÏ°åÎäîÏßÄ ÌôïÏù∏ÌïòÍ∏∞ ÏúÑÌï¥ ÏïÑÎûò ÏøºÎ¶¨Î•º Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rules-list-rules">https://api.cloudflare.com/#waf-rules-list-rules</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/packages/&lt;PACKAGE_ID&gt;/rules?per_page=1000&amp;page=1"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">cr</span> <span class="s1">'.result[] | {id: .id, group: .group.name, mode: .mode} | select(.mode=="off")'</span></code></pre></figure>

<p>modeÍ∞Ä offÏù∏ Î£∞Îì§ÏùÑ ÌëúÏãúÌï¥ Ï£ºÎäî ÏøºÎ¶¨ÏûÖÎãàÎã§. Ìïú ÌéòÏù¥ÏßÄÎãπ 1000Í∞úÍπåÏßÄ ÌëúÏãúÌï† Ïàò ÏûàÎäîÎç∞ OWASP Î£∞ÏùÄ ÏàòÍ∞Ä ÎßéÍ∏∞ ÎïåÎ¨∏Ïóê, Í∫ºÏ†∏ÏûàÎäî Ï†ÑÏ≤¥ Î£∞ÏùÑ ÌëúÏãúÌïòÎ†§Î©¥ <code class="highlighter-rouge">&amp;page=1</code> Î∂ÄÎ∂ÑÏùÑ Î≥ÄÍ≤ΩÌïòÏÖîÏÑú 2020-06-06 Í∏∞Ï§Ä 3ÌéòÏù¥ÏßÄÍπåÏßÄÎäî Î≥¥ÏÖîÏïº Ìï©ÎãàÎã§. Í∑ÄÏ∞ÆÏúºÏãúÎ©¥, Bash ScriptÎ•º Ïç®ÏÑú ÎèåÎ¶¨Î©¥ Ìïú Î≤à ÏΩúÎ°ú Ìö®Ïú®Ìôî Ìï† ÏàòÍ∞Ä ÏûàÍ≤†Ï£†.</p>

<h3 class="no_toc" id="owasp-Î£∞Ïùò-ÎØºÍ∞êÎèÑÏôÄ-Ïï°ÏÖòÏùÑ-Ï°∞Ï†ï">OWASP Î£∞Ïùò ÎØºÍ∞êÎèÑÏôÄ Ïï°ÏÖòÏùÑ Ï°∞Ï†ï</h3>

<p><a href="https://support.cloudflare.com/hc/en-us/articles/200172016-Understanding-the-Cloudflare-Web-Application-Firewall-WAF-#sJbboLurEVhipzWYJQnyz">Í≥µÏãù Í∏∞Ïà†Î¨∏ÏÑú</a>ÏóêÏÑúÎäî OWASP Î£∞Ïùò ÎØºÍ∞êÎèÑÎ•º LowÎ°ú ÏãúÏûëÌïòÍ∏∞Î•º Í∂åÏû•ÌïòÍ≥† ÏûàÏäµÎãàÎã§.</p>

<blockquote>
  <p>Cloudflare recommends initially setting the WAF Sensitivity to Low and reviewing for false positives before further increasing the Sensitivity.</p>
</blockquote>

<p>Ïò§ÌÉêÏùÑ Ï§ÑÏù¥Í∏∞ ÏúÑÌï¥ÏÑúÏûÖÎãàÎã§. Í∑∏Îü¨ÎÇò, Í∂ÅÍ∑πÏ†ÅÏúºÎ°úÎäî <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-ko.html#waf-Î£∞-ÏÑ∏Î∂Ä-Ï°∞Ï†ï-ent-only">Ïò§ÌÉêÏù¥ Î∞úÏÉùÌïòÎäî ÌäπÏ†ï endpointÎ•º ÌäúÎãù Í≥ºÏ†ïÏóêÏÑú ÏòàÏô∏ Ï≤òÎ¶¨ÌïòÎ©¥ÏÑú</a> ÎØºÍ∞êÎèÑÎ•º Medium, ÏµúÏ¢ÖÏ†ÅÏúºÎ°úÎäî <code class="highlighter-rouge">High</code>Î°ú Ïò¨Î¶¨Îäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§. ÎØºÍ∞êÎèÑ HighÏóêÏÑúÎßå Î∞úÍ≤¨ÎêòÎäî ÌäπÏ†ï ÏùµÏä§ÌîåÎ°úÏûáÎì§Ïù¥ ÏûàÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§.</p>

<p>Ïï°ÏÖòÎèÑ ÎßàÏ∞¨Í∞ÄÏßÄÏûÖÎãàÎã§. <code class="highlighter-rouge">Challenge</code> ÌòπÏùÄ <code class="highlighter-rouge">Simulate</code> Î™®ÎìúÎ°ú ÌäúÎãùÏùÑ ÏãúÏûëÌïòÏãúÎêò, <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-ko.html#waf-Î£∞-ÏÑ∏Î∂Ä-Ï°∞Ï†ï-ent-only">Ïò§ÌÉêÏù¥ Î∞úÏÉùÌïòÎäî ÌäπÏ†ï endpointÎ•º ÌäúÎãù Í≥ºÏ†ïÏóêÏÑú ÏòàÏô∏ Ï≤òÎ¶¨ÌïòÎ©¥ÏÑú</a> ÏµúÏ¢Ö ActionÏùÄ <code class="highlighter-rouge">Block</code>Ïù¥ ÎêòÎäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§. Í∑∏ÎûòÏïº OWASP Ï∑®ÏïΩÏ†êÏùÑ ÎÖ∏Î¶¨Îäî ÏïÖÏÑ± Í≥µÍ≤©ÏûêÏùò Î¶¨ÌÄòÏä§Ìä∏Î•º Ïã§Ï†ú Ï∞®Îã®ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.</p>

<p>Í∑ÄÏÇ¨Ïùò Ïñ¥ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÏóê ÏòàÏÉÅÏπò Î™ªÌïú Î¥áÎì§Ïù¥ ÎèåÍ≥† ÏûàÍ±∞ÎÇò, ÎπÑÏ¶àÎãàÏä§Ï†Å Ïù¥Ïú†Î°ú WAFÍ∞Ä Ï¢ãÏïÑÌïòÏßÄ ÏïäÏùÑ ÎßåÌïú Î¶¨ÌÄòÏä§Ìä∏Í∞Ä ÎèåÍ≥† ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§. <code class="highlighter-rouge">Sensitivity:High</code>ÏôÄ <code class="highlighter-rouge">Action:Block</code>ÏùÄ ÏµúÏÉÅÏùò Î≥¥ÏïàÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§Îßå Ïò§ÌÉê Î∞©ÏßÄÏôÄ fine tuning Í≥ºÏ†ï ÏóÜÏù¥ Day 1Î∂ÄÌÑ∞ Ï†ÅÏö©ÌñàÎã§Í∞ÄÎäî unpleasant surprisesÎ•º Í≤™ÏúºÏã§ Ïàò ÏûàÎã§Îäî Ï†ê Ïú†ÏùòÌïòÏÑ∏Ïöî.</p>

<p>ÌäúÎãù Í≥ºÏ†ïÏóêÏÑú <code class="highlighter-rouge">ruleId: 981176</code>ÏúºÎ°ú ÌëúÏãúÎêòÎäî OWASP Î£∞Í≥º Ìä∏Î¶¨Í±∞ÎêòÎäî Path, UAÎì±ÏùÑ ÏßÄÏºúÎ≥¥Î©¥ÏÑú ÏòàÏô∏ Ï≤òÎ¶¨Î•º ÏßÑÌñâÌïòÏÑ∏Ïöî.</p>

<p>ÌäúÎãùÏù¥ ÎÅùÎÇòÎ©¥ ÏòàÏô∏Ï≤òÎ¶¨Îêú ÌäπÏ†ï Path Ïô∏Ïóê Ï†ÑÏó≠ Î£∞ÏùÄ <code class="highlighter-rouge">Sensitivity: High</code> / <code class="highlighter-rouge">Action: Block</code> ÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÎäî Í≤ÉÏù¥ Î™©ÌëúÏûÖÎãàÎã§.</p>

<h3 class="no_toc" id="cloudflare-waf-Î£∞Ïùò-Ïï°ÏÖòÏùÑ-ÏµúÏÜå-simulate-Î™®ÎìúÎ°ú-Ïò¨Î¶¨Í∏∞">Cloudflare WAF Î£∞Ïùò Ïï°ÏÖòÏùÑ ÏµúÏÜå Simulate Î™®ÎìúÎ°ú Ïò¨Î¶¨Í∏∞</h3>

<p>2700ÎßåÍ∞ú(2020-06-06 Í∏∞Ï§Ä) Cloudflare Í≥†Í∞ùÏÑúÎπÑÏä§ Ï§ë, Î™á Í≥≥ÏóêÏÑú Ïò§ÌÉê Í∞ÄÎä•ÏÑ±Ïù¥ Ï†úÍ∏∞ÎêòÏñ¥ Default ÎèôÏûëÏù¥ <code class="highlighter-rouge">Disabled</code>Î°ú ÎêòÏñ¥ ÏûàÎäî Î£∞Îì§Ïù¥ ÏûàÏäµÎãàÎã§. <code class="highlighter-rouge">ruleId 100001: Anomaly:Header:User-Agent - Missing</code> Ïù¥ Ï¢ãÏùÄ ÏòàÏãúÏù∏Îç∞Ïöî, user-Agent ÌïÑÎìúÍ∞Ä ÏóÜÎäî Î¶¨ÌÄòÏä§Ìä∏Îäî Î≥¥ÌÜµ Ï†ïÏÉÅÏúºÎ°ú ÌåêÎã®ÌïòÏßÄ ÏïäÏäµÎãàÎã§. Í∑∏Îü¨ÎÇò ÌóàÏà†ÌïòÍ≤å ÏßúÏó¨ÏßÑ Ïª§Ïä§ÌÖÄ Î¥áÏùÑ Îã§ Ïû°ÏïÑÎÇ¥Í∏∞ ÎïåÎ¨∏Ïóê Ïù¥Îü∞ Î¥áÏùÑ ÏùòÎèÑÏ†ÅÏúºÎ°ú ÎèåÎ¶¨Îäî Î™áÎ™á ÏÇ¨Ïù¥Ìä∏ÏóêÏÑúÎäî Ïò§ÌÉêÏúºÎ°ú ÌåêÎã®ÌïòÏã§ ÏàòÎèÑ ÏûàÏäµÎãàÎã§. CloudflareÎäî 2700ÎßåÍ∞ú(2020-06-06 Í∏∞Ï§Ä) Í≥†Í∞ùÏÑúÎπÑÏä§Î•º Í∏∞Ï§ÄÏúºÎ°ú Ïû°ÏúºÎØÄÎ°ú ÎÖ∏Ïù¥Ï¶àÎ•º Ï§ÑÏù¥Í∏∞ ÏúÑÌï¥ Ïù¥Îü¨Ìïú Î£∞Îì§ÏùÄ Î°úÍπÖ ÏóÜÏù¥ Í∫ºÏ†∏ ÏûàÏäµÎãàÎã§. Í≥†Í∞ùÏÇ¨ ÏûÖÏû•ÏóêÏÑúÎäî Ïù¥Î†áÍ≤å Í∫ºÏ†∏ ÏûàÎäî Î£∞Îì§ÏùÑ Î°úÍπÖ Î™®Îìú <code class="highlighter-rouge">Simulate</code>Î°ú ÎèôÏûëÏúºÎ°ú Î∞îÍæ∏ÏãúÎ©¥, Î∞©Ïñ¥ ÎåÄÏÉÅ ÏÇ¨Ïù¥Ìä∏Ïóê Îì§Ïñ¥Ïò§Îäî Î¶¨ÌÄòÏä§Ìä∏Ïùò ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏïåÏïÑÎ≥∏ Îí§, Ïù¥ÌõÑÏóê Ïï°ÏÖò Î†àÎ≤®ÏùÑ ÎÜíÏù¥Ïã§ÏßÄ ÌòπÏùÄ ÎÇÆÏ∂îÏã§ÏßÄÎ•º Í≤∞Ï†ïÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.</p>

<p>Îî∞ÎùºÏÑú Ïó¨Í∏∞ÏÑúÎäî <code class="highlighter-rouge">Disable</code>Îêú Î£∞Îì§ÏùÑ Î™®Îëê Ï∞æÏïÑÎÇ¥Í≥† <code class="highlighter-rouge">Simulate</code>Î°ú Î∞îÍæ∏Îäî Î≤ïÏùÑ ÏïåÏïÑÎ≥º Í≤ÉÏûÖÎãàÎã§.</p>

<p>Î®ºÏ†Ä, ÏïÑÎûò APIÎ•º Ïç®ÏÑú <code class="highlighter-rouge">Cloudflare Managed Ruleset</code>Ïùò Ìå®ÌÇ§ÏßÄ IDÎ•º ÏñªÏñ¥Ïò§Ïã≠ÏãúÏò§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rule-packages-properties">https://api.cloudflare.com/#waf-rule-packages-properties</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/packages"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s1">'.result[] | {package: .name, id: .id}'</span></code></pre></figure>

<p>ÏïÑÎûò ÏøºÎ¶¨ÏóêÏÑú Î∞©Í∏à ÏñªÏñ¥Ïò® <code class="highlighter-rouge">&lt;PACKAGE_ID&gt;</code> Î∂ÄÎ∂ÑÏùÑ Î∂ôÏó¨ÎÑ£Ïñ¥ ÏïÑÎûò API ÏΩúÏùÑ ÎèåÎ¶¨Ïã≠ÏãúÏò§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rules-list-rules">https://api.cloudflare.com/#waf-rules-list-rules</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/packages/&lt;PACKAGE_ID&gt;/rules?per_page=999&amp;page=1"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">cr</span> <span class="s1">'.result[] | {id: .id, current_action: .mode, default_action: .default_mode} | select(.default_action=="disable" and .current_action=="default", .current_action=="disable")'</span></code></pre></figure>

<p>Ïù¥ ÏøºÎ¶¨Îäî ÌòÑÏû¨ Ïï°ÏÖòÏù¥ <code class="highlighter-rouge">disable</code> Î°ú ÏÑ§Ï†ïÎêú Î™®Îì† Î£∞Í≥º ÌòÑÏû¨ Ïï°ÏÖòÏùÑ ÌëúÏãúÌï¥ Ï§çÎãàÎã§.</p>

<p>Îã§ÏùåÏùÄ ÏïÑÎûò PATCH ÏøºÎ¶¨Î•º Ïù¥Ïö©ÌïòÎäî Bash ScriptÎ•º ÏßúÏÖîÏÑú modeÎ•º Î™®Îëê <code class="highlighter-rouge">simulate</code>Î°ú Î∞îÍøîÏ£ºÎ©¥ Îê©ÎãàÎã§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rules-edit-rule">https://api.cloudflare.com/#waf-rules-edit-rule</a></p>

<p>ÎÅùÎÇòÏÖ®ÏúºÎ©¥ ÌäúÎãù Ï§ÄÎπÑÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïù¥Ï†úÎ∂ÄÌÑ∞Îäî ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Î°úÍπÖÎêòÎäî WAF Î£∞ÏùÑ ÌôïÏù∏Ìï¥ Í∞ÄÏãúÎ©¥ÏÑú ÏïÑÎûò Í∏∞Ï§ÄÏúºÎ°ú ÌäúÎãùÌïòÏãúÎ©¥ Îê©ÎãàÎã§.</p>

<ul>
  <li>ÌåêÎã®Ïóê ÎÖ∏Ïù¥Ï¶àÍ∞Ä ÎêòÎäî Î£∞: Í≥µÍ≤©ÏúºÎ°ú ÌåêÎã®ÎêòÏßÄ ÏïäÎäîÎç∞, ÏßÄÏÜçÏ†ÅÏúºÎ°ú ÎåÄÏãúÎ≥¥ÎìúÏóê Ï∂úÌòÑÌï® - <code class="highlighter-rouge">Disable</code>ÏúºÎ°ú Î≥ÄÍ≤Ω Í≤∞Ï†ï</li>
  <li>ÎçîÏö± Í∞ÄÌòπÌïú(?) Ï≤òÎ≤åÏù¥ ÌïÑÏöîÌïú Î£∞: Î£∞ÏùÑ Ìä∏Î¶¨Í±∞ÌïòÎäî Î¶¨ÌÄòÏä§Ìä∏Îì§Ïù¥ Îß§Ïö∞ ÏàòÏÉÅÌïúÎç∞, ÌòÑÏû¨ Ïï°ÏÖòÏù¥ <code class="highlighter-rouge">Simulate</code>ÎÇò <code class="highlighter-rouge">Challenge</code>Î°ú ÎêòÏñ¥ ÏûàÏùå - <code class="highlighter-rouge">Block</code>ÏúºÎ°ú Î≥ÄÍ≤Ω Í≤∞Ï†ï</li>
</ul>

<h2 id="minimize-false-positives">Minimize False Positives</h2>

<p>Cloudflare WAFÎ•º Ï≤òÏùå ÌôúÏÑ±ÌôîÌïòÏãúÎ©¥, 2020-06-06 Í∏∞Ï§Ä, 413Í∞úÏùò Cloudflare Managed RulesetÍ≥º, 2491+Í∞úÏùò OWASP ModSecurity RulesetÏù¥ Default Î™®ÎìúÎ°ú ÎèôÏûëÌï©ÎãàÎã§. Default Î™®ÎìúÎûÄ 2,700ÎßåÍ∞úÏùò Cloudflare Í≥†Í∞ù ÏÑúÎπÑÏä§Î•º Í∞ÄÏû• ÏµúÏ†ÄÏùò Ïò§ÌÉêÏú®(False Positive)Í≥º ÎØ∏ÌÉêÏú®(False Negative)Î°ú Î≥¥Ìò∏Ìï¥ ÎìúÎ¶¨Í∏∞ ÏúÑÌïú Ï∂îÏ≤ú Î™®ÎìúÏûÖÎãàÎã§.</p>

<p>Îî∞ÎùºÏÑú Ïù¥ Î™®ÎìúÎ•º Í∑∏ÎåÄÎ°ú ÌôúÏö©ÌïòÏãúÍ∏∞Î•º Ï∂îÏ≤úÌïòÎäî ÌïúÌé∏, Ïñ¥ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÎßàÎã§Ïùò ÌäπÏÑ±Ïóê ÎßûÍ≤å, Í∑∏Î¶¨Í≥† Í≥†Í∞ùÏÇ¨Ïùò ÎØºÍ∞êÎèÑÏóê ÎßûÍ≤å fine-tuning ÌïòÏã§ Ïàò ÏûàÎèÑÎ°ù Enterprise Í≥†Í∞ùÏóê ÌïúÏ†ïÌïòÏó¨ ÏßÄÏõêÌï¥ ÎìúÎ¶¨Í≥† ÏûàÏäµÎãàÎã§.</p>

<p>Fine-tuningÏùò ÏãúÏûëÏ†êÏùÑ, <strong>‚ÄòÏã§Ìä∏ÎûòÌîΩÏóê ÏïÑÎ¨¥Îü∞ ÏòÅÌñ•Ïù¥ ÏóÜÎèÑÎ°ù, Î¨¥Ï°∞Í±¥ ÏãúÎÆ¨Î†àÏù¥ÏÖòÎ∂ÄÌÑ∞ ÏãúÏûëÌïòÍ≥† Ïã∂Îã§‚Äô</strong> Î°ú Ïû°ÏúºÏãúÎäî Í≤ΩÏö∞ - Î≥¥ÌÜµ ÏïàÏ†ïÏÑ±ÏùÑ Í∞ÄÏû• Ï§ëÏãúÌïòÏãúÎäî ÏÑúÎπÑÏä§Îäî Ïó¨Í∏∞ÏÑú ÏãúÏûëÌï©ÎãàÎã§ - Ïù¥ ÏÑπÏÖòÏù¥ ÎèÑÏõÄÏù¥ Îê† Í≤ÉÏûÖÎãàÎã§. Ïù¥ Î∞©ÏãùÏúºÎ°ú Í∞ÄÏãúÎäî Í≤ΩÏö∞ Ï∞®Îã® ÏóÜÏù¥ ‚ÄòÌÉêÏßÄ Î™®Îìú‚Äô Î°ú ÏãúÏûëÌï©ÎãàÎã§. Îã§Îßå ÌäúÎãùÏóê ÏãúÍ∞ÑÏùÑ Ïò§Îûò ÎÅåÏßÄ ÏïäÎäî Ìé∏Ïù¥ Ï¢ãÏäµÎãàÎã§. ÏïåÎ†§ÏßÑ ÏùµÏä§ÌîåÎ°úÏûáÎèÑ ÎßâÏßÄ ÏïäÎäî ÏàòÏ§ÄÏóêÏÑú ÏãúÏûëÌïòÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§.</p>

<h3 class="no_toc" id="owasp-waf-Î£∞ÏùÑ-Î™®Îëê-ÏºúÍ∏∞-1">OWASP WAF Î£∞ÏùÑ Î™®Îëê ÏºúÍ∏∞</h3>

<p>Î®ºÏ†Ä, OWASP ModSecurity Core RulesetÏóêÏÑú, Î∞©Ïñ¥ ÎåÄÏÉÅ Í≥†Í∞ùÏÑúÎπÑÏä§ÏôÄ Ïú†Í¥ÄÌïú Î™®Îì† Íµ¨ÌòÑÎêú Î£∞Îì§ÏùÑ Ïº§ Í≤ÉÏûÖÎãàÎã§. <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-ko.html#owasp-waf-%EB%A3%B0%EC%9D%84-%EB%AA%A8%EB%91%90-%EC%BC%9C%EA%B8%B0">Ïù¥ Î∂ÄÎ∂ÑÏùÑ Ï∞∏Í≥†ÌïòÏÑ∏Ïöî.</a></p>

<h3 class="no_toc" id="owasp-Î£∞Ïùò-ÎØºÍ∞êÎèÑÏôÄ-Ïï°ÏÖòÏùÑ-Ï°∞Ï†ï-1">OWASP Î£∞Ïùò ÎØºÍ∞êÎèÑÏôÄ Ïï°ÏÖòÏùÑ Ï°∞Ï†ï</h3>

<p><code class="highlighter-rouge">Sensitivity: Low</code> / <code class="highlighter-rouge">Action: Simulate</code> Î°ú ÏÑ§Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.</p>

<p>Í∂ÅÍ∑πÏ†ÅÏúºÎ°úÎäî <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-ko.html#waf-Î£∞-ÏÑ∏Î∂Ä-Ï°∞Ï†ï-ent-only">Ïò§ÌÉêÏù¥ Î∞úÏÉùÌïòÎäî ÌäπÏ†ï endpointÎ•º ÌäúÎãù Í≥ºÏ†ïÏóêÏÑú ÏòàÏô∏ Ï≤òÎ¶¨ÌïòÎ©¥ÏÑú</a> ÎØºÍ∞êÎèÑÎ•º Medium, ÏµúÏ¢ÖÏ†ÅÏúºÎ°úÎäî <code class="highlighter-rouge">High</code>Î°ú Ïò¨Î¶¨Îäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§. ÎØºÍ∞êÎèÑ HighÏóêÏÑúÎßå Î∞úÍ≤¨ÎêòÎäî ÌäπÏ†ï ÏùµÏä§ÌîåÎ°úÏûáÎì§Ïù¥ ÏûàÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§.</p>

<p>Ïï°ÏÖòÎèÑ ÎßàÏ∞¨Í∞ÄÏßÄÏûÖÎãàÎã§. Simulate Î™®ÎìúÎ°ú ÌäúÎãùÏùÑ ÏãúÏûëÌïòÏãúÎêò, <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-ko.html#waf-Î£∞-ÏÑ∏Î∂Ä-Ï°∞Ï†ï-ent-only">Ïò§ÌÉêÏù¥ Î∞úÏÉùÌïòÎäî ÌäπÏ†ï endpointÎ•º ÌäúÎãù Í≥ºÏ†ïÏóêÏÑú ÏòàÏô∏ Ï≤òÎ¶¨ÌïòÎ©¥ÏÑú</a> ÏµúÏ¢Ö ActionÏùÄ <code class="highlighter-rouge">Block</code>Ïù¥ ÎêòÎäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§. Í∑∏ÎûòÏïº OWASP Ï∑®ÏïΩÏ†êÏùÑ ÎÖ∏Î¶¨Îäî ÏïÖÏÑ± Í≥µÍ≤©ÏûêÏùò Î¶¨ÌÄòÏä§Ìä∏Î•º Ïã§Ï†ú Ï∞®Îã®ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.</p>

<p>ÌäúÎãù Í≥ºÏ†ïÏóêÏÑú <code class="highlighter-rouge">ruleId: 981176</code>ÏúºÎ°ú ÌëúÏãúÎêòÎäî OWASP Î£∞Í≥º Ìä∏Î¶¨Í±∞ÎêòÎäî Path, UAÎì±ÏùÑ ÏßÄÏºúÎ≥¥Î©¥ÏÑú ÏòàÏô∏ Ï≤òÎ¶¨Î•º ÏßÑÌñâÌïòÏÑ∏Ïöî.</p>

<p>ÌäúÎãùÏù¥ ÎÅùÎÇòÎ©¥ ÏòàÏô∏Ï≤òÎ¶¨Îêú ÌäπÏ†ï Path Ïô∏Ïóê Ï†ÑÏó≠ Î£∞ÏùÄ <code class="highlighter-rouge">Sensitivity: High</code> / <code class="highlighter-rouge">Action: Block</code> ÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÎäî Í≤ÉÏù¥ Î™©ÌëúÏûÖÎãàÎã§.</p>

<h3 class="no_toc" id="cloudflare-waf-Î£∞Ïùò-Î™®Îì†-Ïï°ÏÖòÏùÑ-simulateÎ°ú-Î≥ÄÍ≤Ω">Cloudflare WAF Î£∞Ïùò Î™®Îì† Ïï°ÏÖòÏùÑ SimulateÎ°ú Î≥ÄÍ≤Ω</h3>

<p>Cloudflare WAFÎäî 2700ÎßåÍ∞ú(2020-06-06 Í∏∞Ï§Ä) Cloudflare Í≥†Í∞ùÏÑúÎπÑÏä§ ÎåÄÏÉÅÏúºÎ°ú Í∞ÄÏû• ÎÇÆÏùÄ ÎØ∏ÌÉêÏú®/Ïò§ÌÉêÏú®ÏùÑ Î≥¥Ïù¥Îäî Ï∂îÏ≤ú Ïï°ÏÖò ÏÑ§Ï†ï(Default Mode) Ïù¥ ÏûàÏäµÎãàÎã§. Í∞Å Ïï°ÏÖòÏùÄ ÏïÑÎûòÏôÄ Í∞ôÏäµÎãàÎã§.</p>

<ul>
  <li>Disable : ÌóàÏö©</li>
  <li>Simulate : ÌóàÏö©ÌïòÏßÄÎßå, Ïù¥Î≤§Ìä∏Î•º Î°úÍ∑∏</li>
  <li>Challenge : CAPTCHAÎ•º ÌÜµÍ≥ºÌïòÎ©¥ ÌóàÏö©</li>
  <li>Block : Ï∞®Îã®</li>
</ul>

<p>WAFÎ•º ÏÜåÏúÑ <strong>ÌÉêÏßÄ Î™®Îìú</strong>Î°ú ÎèôÏûëÏãúÌÇ§Í∏∞ ÏúÑÌï¥ <code class="highlighter-rouge">Challenge</code>, <code class="highlighter-rouge">Block</code>, (Optional: <code class="highlighter-rouge">Disable</code> Ìè¨Ìï®)ÏúºÎ°ú ÎèôÏûëÌïòÎäî Î£∞ÏùÑ Î™®Îëê <code class="highlighter-rouge">Simulate</code>Î°ú Î∞îÍøÄ Í≤ÉÏûÖÎãàÎã§.</p>

<p>Î®ºÏ†Ä, ÏïÑÎûò APIÎ•º Ïç®ÏÑú <code class="highlighter-rouge">Cloudflare Managed Ruleset</code>Ïùò Ìå®ÌÇ§ÏßÄ IDÎ•º ÏñªÏñ¥Ïò§Ïã≠ÏãúÏò§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rule-packages-properties">https://api.cloudflare.com/#waf-rule-packages-properties</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/packages"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="s1">'.result[] | {package: .name, id: .id}'</span></code></pre></figure>

<p>ÏïÑÎûò ÏøºÎ¶¨ÏóêÏÑú Î∞©Í∏à ÏñªÏñ¥Ïò® <code class="highlighter-rouge">&lt;PACKAGE_ID&gt;</code> Î∂ÄÎ∂ÑÏùÑ Î∂ôÏó¨ÎÑ£Ïñ¥ ÏïÑÎûò API ÏΩúÏùÑ ÎèåÎ¶¨Ïã≠ÏãúÏò§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rules-list-rules">https://api.cloudflare.com/#waf-rules-list-rules</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/packages/&lt;PACKAGE_ID&gt;/rules?per_page=999&amp;page=1"</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">cr</span> <span class="s1">'.result[] | {id: .id, current_action: .mode, default_action: .default_mode} | select(.current_action=="block", .current_action=="challenge", (.current_action=="default" and .default_action=="block"), (.current_action=="default" and .default_action=="challenge"))'</span></code></pre></figure>

<p>Ïù¥ ÏøºÎ¶¨Îäî ÌòÑÏû¨ Ïï°ÏÖòÏù¥ <code class="highlighter-rouge">challenge</code>ÎÇò <code class="highlighter-rouge">block</code>ÏúºÎ°ú ÎêòÏñ¥ ÏûàÎäî Î™®Îì† Î£∞ÏùÑ ÌëúÏãúÌï¥ Ï§çÎãàÎã§.</p>

<p>Îã§ÏùåÏùÄ ÏïÑÎûò PATCH ÏøºÎ¶¨Î•º Ïù¥Ïö©ÌïòÎäî Bash ScriptÎ•º ÏßúÏÖîÏÑú Ìï¥Îãπ Î£∞Ïùò modeÎ•º Î™®Îëê <code class="highlighter-rouge">simulate</code>Î°ú Î∞îÍøîÏ£ºÎ©¥ Îê©ÎãàÎã§.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-rules-edit-rule">https://api.cloudflare.com/#waf-rules-edit-rule</a></p>

<p>ÎÅùÎÇòÏÖ®ÏúºÎ©¥ ÌäúÎãù Ï§ÄÎπÑÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïù¥Ï†úÎ∂ÄÌÑ∞Îäî ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Î°úÍπÖÎêòÎäî WAF Î£∞ÏùÑ ÌôïÏù∏Ìï¥ Í∞ÄÏãúÎ©¥ÏÑú ÏïÑÎûò Í∏∞Ï§ÄÏúºÎ°ú ÌäúÎãùÌïòÏãúÎ©¥ Îê©ÎãàÎã§.</p>

<ul>
  <li>ÏûêÏ£º Ìä∏Î¶¨Í±∞ÎêòÎäî Î£∞: ÌÉêÏßÄÎêòÎäî Í∞úÎ≥Ñ Î£∞ÏÖãÏùò Ï†ïÌÉê Ïó¨Î∂ÄÎ•º ÌåêÎã®ÌïòÏó¨ <code class="highlighter-rouge">Block</code>(Ïù¥ÎÇò <code class="highlighter-rouge">Challenge</code>)ÏúºÎ°ú Î≥ÄÍ≤Ω Í≤∞Ï†ï</li>
  <li>ÌåêÎã®Ïóê ÎÖ∏Ïù¥Ï¶àÍ∞Ä ÎêòÎäî Î£∞: Í≥µÍ≤©ÏúºÎ°ú ÌåêÎã®ÎêòÏßÄ ÏïäÎäîÎç∞, ÏßÄÏÜçÏ†ÅÏúºÎ°ú ÎåÄÏãúÎ≥¥ÎìúÏóê Ï∂úÌòÑÌï® - <code class="highlighter-rouge">Disable</code>ÏúºÎ°ú Î≥ÄÍ≤Ω Í≤∞Ï†ï</li>
</ul>

<h2 id="waf-override-ent-only">WAF Override (ENT Only)</h2>

<p>WAF override allows you to have granular control on WAF rules based on specific URI. As of 2020-06-03, this feature is:</p>

<ul>
  <li>Enterprise only</li>
  <li>API only</li>
</ul>

<p>So you should use API. In this example, I will walk you through on how to disable <code class="highlighter-rouge">Cloudflare WAF - OWASP Ruleset</code> for particular URIs.</p>

<h3 id="retrieve-current-waf-override-rules">Retrieve current WAF Override rules</h3>

<p>Firstly, retrieve the WAF override rules you have in place at the moment.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-overrides-list-uri-controlled-waf-configurations">https://api.cloudflare.com/#waf-overrides-list-uri-controlled-waf-configurations</a></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="no">X</span> <span class="no">GET</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/overrides?page=1&amp;per_page=50"</span> <span class="p">\</span>
       <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
       <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="p">\</span>
       <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>

<p>If you‚Äôre just getting started with WAF Override, unlikely you get anything from this.</p>

<h3 id="create-a-new-waf-override-rule">Create a new WAF Override rule</h3>

<p>Next, create a WAF override rule to bypass OWASP rulesets for your certain endpoint.</p>

<p>Source: <a href="https://api.cloudflare.com/#waf-overrides-create-a-uri-controlled-waf-configuration">https://api.cloudflare.com/#waf-overrides-create-a-uri-controlled-waf-configuration</a></p>

<ul>
  <li><code class="highlighter-rouge">&lt;RULE_DESCRIPTION&gt;</code> : Write human-readable rule description. e.g.: Set OWASP to Simulate to API POST endpoints</li>
  <li><code class="highlighter-rouge">&lt;YOUR_URI&gt;</code> : List the URIs you want to deploy this change. e.g.: <code class="highlighter-rouge">"api.jeann.net/exampleurl"</code>. This is an array field so you can put multiple urls. e.g.: <code class="highlighter-rouge">"a.jeann.net/url","b.jeann.net/*","c.jeann.net/rrr*"</code>. Wildcard is supported.</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="no">X</span> <span class="no">POST</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/overrides"</span> <span class="p">\</span>
      <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
      <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="p">\</span>
      <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="p">\</span>
      <span class="o">--</span><span class="n">data</span> <span class="s1">'{"description":"&lt;RULE_DESCRIPTION&gt;","urls":[&lt;YOUR_URI&gt;],"rules":{"981176":"simulate"}}}}'</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>

<p>Make sure you see success message from your query. <code class="highlighter-rouge">{"981176":"simulate"}</code> part will bypass the OWASP ruleset. Cloudflare Managed Ruleset will still protect the URIs. Also, because we‚Äôre putting this rule to simulate, you‚Äôll still be able to see logs from Firewall Events.</p>

<p>Now, verify if the rule was created successfully, by <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-en.html#retrieve-current-waf-override-rules">using GET query again.</a></p>

<h3 id="delete-undesired-override-rules">Delete undesired override rules</h3>

<p>Source: <a href="https://api.cloudflare.com/#waf-overrides-delete-uri-controlled-waf-configuration">https://api.cloudflare.com/#waf-overrides-delete-uri-controlled-waf-configuration</a></p>

<p>No need of WAF Override rule anymore? Then you can delete them using DELETE method. Firstly, <a href="/cloudflare/analytics/2020/05/28/frequently-asked-api-calls-en.html#retrieve-current-waf-override-rules">use this query to get the ID of your overrride rule.</a></p>

<p>You should be able to get the ID that looks like below:</p>

<p><code class="highlighter-rouge">"id": "8594d2aa69e840189ba3328ce3ee5c41"</code></p>

<p>Now, run the below query. Replace <code class="highlighter-rouge">&lt;RULE_ID&gt;</code> to your ID.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">curl</span> <span class="o">-</span><span class="no">X</span> <span class="no">DELETE</span> <span class="s2">"https://api.cloudflare.com/client/v4/zones/&lt;ZONE_ID&gt;/firewall/waf/overrides/&lt;RULE_ID&gt;"</span> <span class="p">\</span>
      <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Email: &lt;YOUR_EMAIL&gt;"</span> <span class="p">\</span>
      <span class="o">-</span><span class="no">H</span> <span class="s2">"X-Auth-Key: &lt;API_KEY&gt;"</span> <span class="p">\</span>
      <span class="o">-</span><span class="no">H</span> <span class="s2">"Content-Type: application/json"</span> <span class="o">|</span> <span class="n">jq</span></code></pre></figure>
:ET